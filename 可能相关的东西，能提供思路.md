可能相关的东西，能提供思路

## 1.授权进程和非授权进程读取说明

```
   /*
        * 缓冲读请求，对于授权进程和非授权进程，都要读取文件的明文长度StreamContext->FileSize，
        * 备份进程要读到全部文件长度Fcb->FileSize。
        * 
        *    StreamContext->FileSize             SectorSize                          Fcb->FileSize               Fcb->Allocation
        *              |
        *           |123.......|.....................|....Tailer...........................|...........................|
        *           0         0x10                 0x200                                 0x1200                      0x1600
        *                      |
        *                AES_BLOCK_SIZE
        * 
        * 明文缓冲的数据有效长度是到SectorSize，密文缓冲是到Fcb->Allocation，正常情况下，缓冲内数据的大小是Fcb->Allocation。
        * 
        * Fcb->FileSize的作用和我们minifilter的StreamContext->FileSize的作用是一样的，只不过，
        * Fcb->FileSize是文件系统驱动向上层指定的文件结尾，StreamContext->FileSize是minifilter向上层指定的文件结尾。
        */
```



这段注释是关于如何处理文件读取请求，尤其是在加密文件系统中的明文和密文文件长度的差异。它涉及到文件的明文大小、密文大小、文件分配的空间以及不同进程对这些数据的访问。



### 核心概念：

1. **授权进程与非授权进程**：
   - **授权进程**：有权限访问文件的原始明文数据（未加密的内容）。
   - **非授权进程**：没有权限访问明文数据，可能只能看到加密的密文。
2. **StreamContext** 和 **Fcb**：
   - **StreamContext->FileSize**：这是 minifilter 驱动程序用于跟踪文件的**明文大小**。对于授权和非授权进程，读取时都以这个大小为基础，确保读取的文件数据长度是明文文件的长度。
   - **Fcb->FileSize**：文件系统驱动中描述文件的大小，通常反映加密文件的总大小。
3. **文件大小和不同的长度**：
   - **StreamContext->FileSize** 是明文文件的大小，比如文件的真实内容大小。
   - **Fcb->FileSize** 是文件系统驱动所呈现的文件大小，通常会包括一些文件尾部的加密数据（如密文中的尾部信息）。
   - **Fcb->Allocation**：这是文件分配的空间大小，包含文件存储的物理空间（密文），通常比 `Fcb->FileSize` 更大。

### 结构解释：

图示大致解释了明文和密文文件在不同大小上的映射。

- **明文文件（StreamContext->FileSize）**：表示文件的实际内容大小，比如 `0x10`。
- **密文文件**：加密后的文件数据长度，通常比明文更大，比如加上了 AES 加密尾部的元数据（`0x200`、`0x1200` 等）。
- **Fcb->FileSize**：文件系统表示的文件大小，也就是加密后文件的大小，比如 `0x1200`。
- **Fcb->Allocation**：分配的物理存储空间，比如 `0x1600`，它比 `Fcb->FileSize` 更大，可能还包括文件尾部的预留空间。

### 数据缓冲说明：

- **明文缓冲区有效长度**：表示到 `SectorSize`（`0x200`），这可能是 AES 密文块的长度，明文的读取只到 `SectorSize`。
- **密文缓冲区有效长度**：到 `Fcb->Allocation`，这是加密数据的实际大小，密文的数据可能比明文更大，包含一些元数据。

### 不同进程的读取行为：

- **授权进程和非授权进程**：不论是否授权，都读取明文文件的实际大小（`StreamContext->FileSize`），确保数据的读取是对称的，除非是备份进程。
- **备份进程**：备份进程会读取文件的全部长度，即 `Fcb->FileSize`，因为备份的目的是复制整个文件，包括加密后的数据。

### 小结：

这段注释解释了文件系统在处理加密文件时，如何根据不同的上下文（授权或非授权进程）读取明文或密文的不同部分。同时还提到文件的明文大小与加密后的文件大小如何映射在内存缓冲区中的关系。





## 2.文件存储方式

### 一般文件存储方式（无加密）

1. **文件分块**：
   - 文件通常以块（block）或扇区（sector）的形式存储在磁盘上。大多数文件系统（如 NTFS、ext4）将文件分割成多个块来存储，每个块可能有 4KB 或 8KB 的大小。
2. **文件元数据**：
   - 除了文件内容，文件系统还需要存储文件的元数据（如文件大小、权限、时间戳等），这些信息存储在文件系统的控制数据结构中，比如 NTFS 中的 MFT（主文件表）或 ext4 中的 inode。
3. **空闲空间管理**：
   - 文件系统管理磁盘的空闲空间，并通过分配连续或非连续的磁盘块来存储文件。文件系统将根据需要分配更多的块以容纳文件。

### 加密文件系统中的存储方式

在加密文件系统中，文件的存储方式和普通文件系统有所不同，因为加密增加了一层复杂性。

#### 1. **明文 vs 密文**

- 文件的实际数据（**明文**）不会直接存储在磁盘上。相反，文件的**加密版本（密文）**被存储在磁盘上。
- 例如：如果一个文件的明文大小是 16KB，在加密后它可能会变大（例如，加入加密的元数据或填充等），密文可能存储在磁盘上占用 20KB 或更多。

#### 2. **文件块的加密**

- 通常，文件系统会以块为单位对文件进行加密。每个块中的数据会通过某种加密算法（如 AES）加密，然后将加密后的数据存储在磁盘上。
- 加密后的数据存储格式：
  - **密文块 1** | **密文块 2** | ... | **密文块 N**
  - 这些密文块对应的是文件的不同部分，但它们并不是明文数据的直接映射。

#### 3. **加密元数据**

- 加密文件系统通常会在文件的末尾或文件系统的特定位置存储加密相关的元数据，例如：
  - **IV（初始化向量）**：用于加密操作的初始值。
  - **加密算法标识**：文件加密时使用的算法类型。
  - **密文校验信息**：用于确保密文数据的完整性。

#### 4. **扇区对齐**

- 一些加密文件系统会将加密后的文件大小对齐到磁盘的扇区大小或块大小。这意味着即使明文文件的大小不是块的整数倍，加密后的文件可能会被填充到对齐的大小。
- 例如：如果磁盘的扇区大小是 512 字节，但明文文件只有 300 字节，文件可能会被填充到 512 字节后再加密。

#### 5. **文件系统结构的映射**

- **明文文件大小**（`StreamContext->FileSize`）：这个是文件的原始大小，但它不会直接存储在磁盘上。加密文件系统会保存这部分信息，以便在解密时知道文件的实际大小。
- **加密文件大小**（`Fcb->FileSize`）：这是文件在磁盘上经过加密后的实际存储大小，通常会比明文文件大，可能包含加密的尾部数据、校验码或其他信息。
- **分配大小**（`Fcb->Allocation`）：这是文件在磁盘上分配的物理空间大小，通常会比文件的实际大小更大，因为磁盘块可能比文件所需空间多出一些。

#### 6. **文件系统操作**

- 当你读取或写入文件时，文件系统会根据是否是

  授权进程

  决定返回明文还是密文。

  - **授权进程**：读取文件时，文件系统会从磁盘读取密文，并在返回前对数据进行解密，以提供明文数据。
  - **非授权进程**：读取文件时，可能直接提供加密后的密文，而不会解密数据。

### 简化的存储流程：

1. **文件创建/写入**：
   - 用户创建或写入文件时，文件系统会对数据进行加密。
   - 加密后的数据块存储在磁盘上，并记录加密的元数据信息。
   - 记录 `StreamContext->FileSize`（明文大小）和 `Fcb->FileSize`（加密后的大小）。
2. **文件读取**：
   - 用户请求读取文件时，文件系统首先检查用户权限。
   - 授权用户：从磁盘读取密文后解密，返回明文数据。
   - 非授权用户：返回加密的密文数据。

### 总结：

- **普通文件系统**：文件分块存储，元数据和文件内容在磁盘上分开管理。
- **加密文件系统**：文件在磁盘上存储为密文，文件的明文大小和加密后的大小可能不同，并且密文可能包含额外的元数据或校验信息。